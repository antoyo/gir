use std::str::FromStr;
use toml::Value;

#[derive(Clone, Copy, Debug, Eq, PartialEq)]
pub enum GType {
    Enum,
    Interface,
    Widget,
    Unknown,
    //TODO: Object, InitiallyUnowned,
}

impl FromStr for GType {
    type Err = String;
    fn from_str(s: &str) -> Result<Self, Self::Err> {
        match s {
            "enum" => Ok(GType::Enum),
            "interface" => Ok(GType::Interface),
            "widget" => Ok(GType::Widget),
            _ => Err("Wrong object type".into())
        }
    }
}

#[derive(Clone, Copy, Debug, Eq, PartialEq)]
pub enum GStatus {
    Manual,     //already generated
    Generate,
    Comment,
    Ignore,
}

impl FromStr for GStatus {
    type Err = String;
    fn from_str(s: &str) -> Result<Self, Self::Err> {
        match s {
            "manual" => Ok(GStatus::Manual),
            "generate" => Ok(GStatus::Generate),
            "comment" => Ok(GStatus::Comment),
            "ignore" => Ok(GStatus::Ignore),
            _ => Err("Wrong object status".into())
        }
    }
}

/// Info about GObject descendant
#[derive(Debug)]
pub struct GObject {
    pub name: String,
    pub gtype: GType,
    pub status: GStatus,
    pub last_parent: bool,
}

//TODO: make it const
pub fn default_object() -> GObject {
    GObject {
        name: "Default".into(),
        gtype: GType::Unknown,
        status: GStatus::Ignore,
        last_parent: false,
    }
}

pub type GObjects =  Vec<GObject>;

pub trait GObjectsFinder {
    fn find(&self, name: &str) -> Option<&GObject>;
}

impl GObjectsFinder for GObjects {
    fn find(&self, name: &str) -> Option<&GObject>{
        for obj in self {
            if &obj.name == name { return Some(&obj); }
        }
        None
    }
}

pub fn parse_toml(toml_objects: &Value) -> GObjects {
    let mut objects = GObjects::new();
    for toml_object in toml_objects.as_slice().unwrap() {
        let gobject = parse_object(toml_object);
        objects.push(gobject);
    }
    objects
}

fn parse_object(toml_object: &Value) -> GObject {
    let name = toml_object.lookup("name").unwrap_or_else(|| panic!("Object name not defined"))
        .as_str().unwrap().into();

    let gtype = match toml_object.lookup("type") {
        Some(value) => GType::from_str(value.as_str().unwrap()).unwrap_or(GType::Widget),
        None => GType::Widget,
    };
    let status = match toml_object.lookup("status") {
        Some(value) => GStatus::from_str(value.as_str().unwrap()).unwrap_or(GStatus::Ignore),
        None => GStatus::Ignore,
    };
    let last_parent = match toml_object.lookup("last_parent") {
        Some(&Value::Boolean(b)) => b,
        _ => false,
    };
    GObject { name: name, gtype: gtype, status: status, last_parent: last_parent }
}
